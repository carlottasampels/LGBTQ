---
title: "Correlation Matrix"
author: "Rosie Watts, Christopher Huebel, Helena Davies"
date: "20/06/2023"
output:
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    df_print: paged
editor_options: 
  markdown: 
    wrap: 72
---

Are the explanatory variables highly correlated?

To answer the first two research questions we will use a heterogeneous
correlation matrix to test the correlations of both continuous and
categorical data.

# Set up R Markdown

```{r setup, include=FALSE, out.width='100%'}
knitr::opts_chunk$set(echo = TRUE)
```

Clear Global Environment

```{r clear global environment}
rm(list = ls(all.names = TRUE)) 
```

Set current date

```{r current date}
#date <- Sys.Date()
date <- "2025-08-06"
```

Install necessary packages

```{r install packages, eval=FALSE, include=FALSE}
#install.packages("knitr")
#install.packages("summarytools")
#install.packages("polycor")
#install.packages("ggcorrplot")
#install.packages("broom")
#install.packages("poolr")
#install.packages("officer")
#install.packages("flextable")
#install.packages("tidyverse")
```

Load packages

```{r load packages}
library(summarytools)
library(polycor)
library(ggcorrplot)
library(poolr)
library(patchwork)
library(openxlsx)
library(officer)
library(flextable)
library(tidyverse)
```


Read in file with path to ilovedata channel on Teams
Ensure that your credentials directory is correctly located
```{r Read in paths file}
source(file = "credentials/paths.R")
```

Add the add_numeric function - used to convert character variables into numeric variables.
Add the sumscores function - used to generate sumscores
Add the package_check function - used to install and load dependencies
```{r Read in functions}
source(file = paste0(ilovedata_scripts, "functions/add_numeric.R"))
source(file = paste0(ilovedata_scripts, "functions/remove_duplicates.R"))
source(file = paste0(ilovedata_scripts, "functions/sumscores.R"))
source(file = paste0(ilovedata_scripts, "functions/package_check.R"))
source(file = paste0(ilovedata_scripts, "functions/imp_check.R"))
source(file = paste0(ilovedata_scripts, "functions/recode_check.R"))
```

Create plot output folder
```{r Create plot output folder}
#dir.create(paste0(LGBTQ_folder, "tables/"))
dir.create(paste0(LGBTQ_folder, "tables/", date))
```

Read in clean data

```{r read in clean data}
dat <- read_rds(
  file =
    paste0(filepath_cleaned_data,"dat_after_exclusion_gender", date, ".rds")
)
```

Xlsx workbook and output

```{r Define xlsx and workbook}
# Create workbook
wb_fa <- createWorkbook()

# Define path
xlsx_path <- paste0(LGBTQ_folder, "tables/", date, "/LGBTQ_correlation", date, ".xlsx")
```

Variables
```{r}
dat %>% names
```


```{r Variables to rename}
variables_to_rename <- c(
  # Select continuous data for polyserial correlations
    "PHQ9 score" = "V1",                                  
    "Age [years]" = "V2",
    "BMI [kg/m2]"  = "V3", 
    "Height [m]" = "V4",
    
    # Demographics
    "Gender" = "V5",
    "Ethnicity" = "V6",
    "Sexual orientation" = "V7",
    
    # Education
    "Highest education" = "V8",
    
    # Mental health diagnoses
    "Major depressive disorder" = "V9",
    "Generalised anxiety disorder" = "V10",
    "Social anxiety" = "V11",
    "Specific phobia" = "V12",
    "Agoraphobia" = "V13",
    "Panic disorder" = "V14",
    "Panic_attacks" = "V15",
    "Bipolar_disorder" = "V16",                                
    "Obsessive-compulsive disorder" = "V17",
    "Body dysmorphic disorder" = "V18",
    "Anorexia nervosa" = "V19", 
    "Atypical anorexia nervosa" = "V20",
    "Bulimia nervosa" = "V21",
    "Binge-eating disorder" = "V22"
)
```

```{r Korrelationstest}
#install.packages("vcd")   # falls noch nicht installiert
library(vcd)
# Kontingenztabelle erstellen
tab <- table(dat$gender, dat$sex)
tab2 <- table(dat$sexual_orientation, dat$sex)
tab2

assocstats(tab)
assocstats(tab2)

```



# Calculate Spearman Correlations

## Continuous variables

Select the variables for the Spearman correlations, because they are not
normally distributed.

```{r select continous variables}
dat_spearman_continous_vars <- dat %>% 
  select(
   # Continuous variables: 
    "PHQ9 score" = "phq9.sum_score",
    "Age [years]" = "age",
    "BMI [kg/m2]"  = "bmi", 
    "Height [m]" = "height_m"
    )
```

Calculation Spearman correlations

```{r calculate spearman correlations}
spearmans_cors <- Hmisc::rcorr(
  x = as.matrix(dat_spearman_continous_vars), 
  type = "spearman"
  )

spearmans_cors
```

Extract the correlations from the data object into a matrix

```{r spearman correlations matrix}
spearman_correlations <- as.matrix(spearmans_cors$r)
spearman_correlations
```

Extract the p values from the data object into a matrix


```{r spearman p value matrix}
spearman_p_values <- as.matrix(spearmans_cors$P)
spearman_p_values
```

Extract n on which correlation estimates are based on

```{r spearman n matrix}
spearman_n <- as.matrix(spearmans_cors$n)
spearman_n
```

# Calculate Polychoric and Polyserial Correlations using Hetcor

-   tetrachoric: two dichotomous variables

-   polychoric: two ordinal variables

-   polyserial: one ordinal and one continuous variable

## Factor data

```{r Factor data}
dat_factor <- dat %>% 
  select(
    
    # Select continuous data for polyserial correlations
    #"PHQ9 score" = "phq9.sum_score",                                  
    "Age [years]" = "age",
    "BMI [kg/m2]"  = "bmi", 
    "Height [m]" = "height_m",
    
    # Demographics
    "Biologisches Geschlecht" = "sex",
    "Gender" = "gender",
    "Sexuelle Orientierung" = "sexual_orientation",
    "Ethnezität" = "ethnicity",
#    "Gender" = "gender",
 #   "Sexual orientation" = "sexual_orientation",
  #  "Ethnicity" = "ethnicity",
    
    # Education
    "Highest education" = "dem.highest_education_collapsed",
    
    # Mental health diagnoses
    "schwere depressive Störung" = "any_mdd_diagnosis",
    "Generalisierte Angststörung" = "any_gad_diagnosis",
#    "Major depressive disorder" = "mhd.mdd",
 #   "Generalised anxiety disorder" = "mhd.gad",
    "Social anxiety" = "mhd.social_anxiety",
    "Specific phobia" = "mhd.specific_phobia",
    "Agoraphobia" = "mhd.agoraphobia",
    #"Panic disorder" = "mhd.panic_disorder",
    "Panic attacks" = "mhd.panic_attacks",
    "Bipolar disorder" = "mhd.bipolar_disorder",  
    "Obsessive-compulsive disorder" = "mhd.ocd",
    "Body dysmorphic disorder" = "mhd.bdd",
    "Anorexia nervosa" = "mhd.an", 
    "Atypical anorexia nervosa" = "mhd.atypical_an",
    "Bulimia nervosa" = "mhd.bn",
    "Binge-eating disorder" = "mhd.bed"
    )
```

## Hetcor matrix function

Select variables and run hetcor using pairwise complete observations.

And print het_cor =

1\. Correlation coefficients and type of correlations

2\. Standard errors and number of pairwise complete observations

3\. p-values

```{r select variables and run hetcor}
het_cor <- dat_factor %>% 
  as.data.frame() %>%
  hetcor(
    use = "pairwise.complete.obs",
#    ML = TRUE,
    parallel = TRUE
  )

# Print the correlation matrix
print(
  het_cor,
  digits = max(3, getOption("digits") - 3)
  ) 
```

Save as a correlation matrix

```{r het cor as matrix}
het_cor_matrix <- as.matrix(het_cor)
het_cor_matrix %>%
  round(2)
```

Save p-values from the correlation matrix as an object

```{r het cor p values matrix}
het_cor_pvalue_matrix <- as.matrix(het_cor$tests)
het_cor_pvalue_matrix 
```

```{r het cor n matrix}
het_cor_n_matrix <- as.matrix(het_cor$n)
het_cor_n_matrix
```

# Replace Pearson correlations with spearman correlations

Save a copy of the het cor matrix

```{r create a copy of r het cor matrix}
het_cor_matrix_merged <- het_cor_matrix
```

Replace Pearson corrleations with Spearman's

```{r replace pearson correlations}
het_cor_matrix_merged[1:4,1:4] <- spearman_correlations[1:4,1:4]
het_cor_matrix[1:4,1:4]
het_cor_matrix_merged[1:4,1:4]

dim(spearman_correlations)
```

Save a copy of the het cor p-value matrix

```{r create a copy of pvalue het cor matrix}
het_cor_pvalue_matrix_merged <- het_cor_pvalue_matrix
```

Replace p-values

```{r replace pearson p values}
het_cor_pvalue_matrix_merged[1:4,1:4] <- spearman_p_values[1:4,1:4]
het_cor_pvalue_matrix[1:4,1:4]
het_cor_pvalue_matrix_merged[1:4,1:4]
```

Save a copy of the het cor n matrix

```{r create a copy of het cor n matrix}
het_cor_n_matrix_merged <- het_cor_n_matrix
```

Replace n

```{r replace pearson n values}
het_cor_n_matrix_merged[1:4,1:4] <- spearman_n[1:4,1:4]
het_cor_n_matrix[1:4,1:4]
het_cor_n_matrix_merged[1:4,1:4]
```

## Independent traits

Calculate the number of independent traits within the correlation matrix
to adjust for multiple testing:

<https://www.rdocumentation.org/packages/poolr/versions/1.0-0/topics/meff>
Methods: "nyholt", "liji", "gao", or "galwey"

We divide the alpha threshold 0.05 by the number of independent traits
in the correlation matrix.

```{r correlation matrix independent traits}
het_cor_merged_indep_traits <- poolr::meff(
  R = het_cor_matrix_merged, 
  method = "galwey"
  )
het_cor_merged_indep_traits
```

### Bonferroni-adjusted p value threshold

```{r items.renamed correlation matrix Bonferroni p value threshold}
correlation_bonferroni_p_value_threshold <- 0.05/het_cor_merged_indep_traits
correlation_bonferroni_p_value_threshold
```

# Plot correlation matrix

```{r correlation matrix plot, fig.height=9.84, fig.width=9.84}
correlation_matrix <- ggcorrplot(
  het_cor_matrix_merged,
  hc.order = FALSE, # hierarchical clustering
  outline.color = "white", # colour of outlines
  type = "lower", # display only lower triangle
  ggtheme = ggplot2::theme_minimal,
  colors = c(
    "dodgerblue4",
    "white",
    "firebrick4"),
  lab = TRUE, # show correlation values
  #p.mat = het_cor_pvalue_matrix_merged, # matrix with p values
  sig.level = correlation_bonferroni_p_value_threshold, # choose significant level
  insig = "pch" # Nonsignificant correlations are crossed out
  ) + theme(axis.text.x = element_text(colour = "black", size = 12),
          axis.text.y = element_text(colour = "black", size = 12))

correlation_matrix
```

Save correlation matrix plot

```{r correlation matrix plot ggsave}
ggsave(
  filename = paste0("LGBTQ_correlation_matrix", date, ".png"),
  plot = correlation_matrix,
  device = "png", 
  path = paste0(LGBTQ_folder, "plots/"),
  width = 32,
  height = 32,
  dpi = 300, 
  units = "cm",
  bg = "white"
  )
```

# Create a table of the correlation matrix

```{r correlation matrix data frame}
# Get the lower triangle indices
lower_triangle_indices <- which(lower.tri(het_cor_matrix_merged), arr.ind = TRUE)

# Create a dataframe for lower triangle values
cor_table <- data.frame(
  Var1 = rownames(het_cor_matrix_merged)[lower_triangle_indices[,1]],
  Var2 = colnames(het_cor_matrix_merged)[lower_triangle_indices[,2]],
  Correlation = het_cor_matrix_merged[lower_triangle_indices]
  ) %>%
  rename(
    "Variable 1" = "Var1", 
    "Variable 2" = "Var2") %>%
  mutate(Correlation = round(Correlation, digits = 2))

cor_table
```


```{r p value table}
# Get the lower triangle indices
lower_triangle_indices_pvalue <- which(lower.tri(het_cor_pvalue_matrix_merged), arr.ind = TRUE)

# Create a dataframe for lower triangle values
pvalue_table <- data.frame(
  Var1 = rownames(het_cor_pvalue_matrix_merged)[lower_triangle_indices_pvalue[,1]],
  Var2 = colnames(het_cor_pvalue_matrix_merged)[lower_triangle_indices_pvalue[,2]],
  pvalue = het_cor_pvalue_matrix_merged[lower_triangle_indices_pvalue]
  ) %>%
  rename(
    "Variable 1" = "Var1", 
    "Variable 2" = "Var2") %>%
  mutate(pvalue = format.pval(
    pvalue,
    digits = 3,
    #eps = 0.001,
    scientific = TRUE))

pvalue_table
```

# Bind correlation & p value

```{r}
cor_pvalue_table <- 
  bind_cols(
    cor_table,
    pvalue_table %>%
      select(
        pvalue
      )
  )

cor_pvalue_table
```

## Save table

```{r}
# Assuming you have a tibble called 'my_tibble'
my_flextable <- flextable(cor_pvalue_table)

# Create a Word document
doc <- read_docx()

# Insert the flextable into the document
doc <- body_add_flextable(doc, value = my_flextable)

# Save the document to a Word file
print(
  doc,
  target =
    paste0(LGBTQ_folder, "tables/", date, "/LGBTQ_cor_pvalue_table", date, ".docx")
      )
```


# Number of pairwise complete obs in each correlation 

Include this as an appendix
```{r  number of pairwise complete obs in each correlation}
n = as.data.frame(
  het_cor_n_matrix_merged
)
```

Rename variable names 
```{r  rename column names}
n_renamed <- n %>% 
  rename(
# Select continuous data for polyserial correlations
    "PHQ9 score" = "V1",                                  
    "Age [years]" = "V2",
    "BMI [kg/m2]"  = "V3", 
    "Height [m]" = "V4",
    
    # Demographics
    "Gender" = "V5",
    "Ethnicity" = "V6",
    "Sexual orientation" = "V7",
    
    # Education
    "Highest education" = "V8",
    
    # Mental health diagnoses
    "Major depressive disorder" = "V9",
    "Generalised anxiety disorder" = "V10",
    "Social anxiety" = "V11",
    "Specific phobia" = "V12",
    "Agoraphobia" = "V13",
    "Panic disorder" = "V14",
    "Panic_attacks" = "V15",
    "Bipolar_disorder" = "V16",                                
    "Obsessive-compulsive disorder" = "V17",
    "Body dysmorphic disorder" = "V18",
    "Anorexia nervosa" = "V19", 
    "Atypical anorexia nervosa" = "V20",
    "Bulimia nervosa" = "V21",
    "Binge-eating disorder" = "V22"
  )
```

Mutate column with row names

```{r  new column with row names}
correlation_number <- 
  n_renamed %>% 
  mutate(
    ID = 1:nrow(.),
    Trait = colnames(n_renamed)
  ) %>%
  relocate(
    ID, Trait
  )

correlation_number
```


Write as an excel to format table and attach as an appendix
```{r  save as excel}
openxlsx::write.xlsx(
  correlation_number,
  file = paste0(LGBTQ_folder, "tables/", date, "/LGBTQ_cor_numbers", date, ".xlsx"),
  sheetName = "Sheet2",
  colNames = TRUE,
  rowNames = TRUE,
  append = FALSE,
  showNA = TRUE,
  password = NULL
)
```
