---
title: "data_exclusion"
author: ""
date: "15/06/2025"
output:
  html_document:
    toc: true
    toc_depth: 4
    number_sections: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    df_print: paged
editor_options: 
  markdown: 
    wrap: 72
---

# Setup

```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment=NA,
                      prompt=FALSE,
                      cache=FALSE)
```

## Clear workspace

```{r Clear worksapce}
rm(list = ls())
```


Read in file with path to ilovedata channel on Teams
```{r Read in paths file}
source(file = "credentials/paths.R")
```


Add the add_numeric function - used to convert character variables into numeric variables.
Add the sumscores function - used to generate sumscores
Add the package_check function - used to install and load dependencies
```{r Read in functions}
source(file = paste0(ilovedata_scripts, "functions/add_numeric.R"))
source(file = paste0(ilovedata_scripts, "functions/remove_duplicates.R"))
source(file = paste0(ilovedata_scripts, "functions/sumscores.R"))
source(file = paste0(ilovedata_scripts, "functions/package_check.R"))
source(file = paste0(ilovedata_scripts, "functions/imp_check.R"))
source(file = paste0(ilovedata_scripts, "functions/recode_check.R"))
```


## Install packages

```{r Install packages}
#install.packages("ggformula")
#install.packages("tidyverse")
```

## Load packages

```{r Load packages}
#library(openxlsx)
library(gtsummary)
#library(ggconsort)
library(tidyverse)
```

## Retrieve the recent date

```{r Recent date}
date = Sys.Date()
date
```

## Read in data

```{r Read in data}
dat <- read_rds(
  file = paste0(filepath_cleaned_data,"dat_variable_creation", date, ".rds"))
```


Psychiatric diagnoses
```{r Psychiatric diagnoses vector}
psy_dx_factors <- c(
  "mhd.mdd",
  "mhd.gad",
  "mhd.social_anxiety",
  "mhd.specific_phobia",
  "mhd.agoraphobia",
  "mhd.panic_disorder",
  "mhd.panic_attacks",
  "mhd.bipolar_disorder",
  "mhd.ocd",
  "mhd.bdd",
  "mhd.an",
  "mhd.atypical_an",
  "mhd.bn",
  "mhd.bed"
)
```

Analysis variables vector

```{r}
analysis_variables_vector <- c(
  "phq9.sum_score", 
  "phq.Q9_suicidality_binary_numeric", # Suicidality
  "phq.Q9_suicidality_binary",
  "gender",
  "sex",
  "age",
  "bmi",
  "height_m",
  "ethnicity",
  "sexual_orientation",
  "dem.highest_education_collapsed",
  psy_dx_factors
)
```


# Exclusion criteria

## Exclusion table

-555 'Not applicable' response from participant
-666 Implausible response/value
-777 Seen but not answered
-888 Don't know
-999 Prefer not to answer/Prefer not to say

```{r Exclusion table demographics exposure outcome}
dat %>%
  select(
    age,
    gender,
    sex,
    ethnicity,
    sexual_orientation,
    height_m,
    bmi,
    dem.highest_education_collapsed,
    #phq9.sum_score,
    any_mdd_diagnosis,
    any_gad_diagnosis,
  "mhd.mdd",
  "mhd.gad",
  "mhd.social_anxiety",
  "mhd.specific_phobia",
  "mhd.agoraphobia",
  "mhd.panic_disorder",
  "mhd.panic_attacks",
  "mhd.bipolar_disorder",
  "mhd.ocd",
  "mhd.bdd",
  "mhd.an",
  "mhd.atypical_an",
  "mhd.bn",
  "mhd.bed"
) %>%
  gtsummary::tbl_summary()
```


# Exclusion manually

## gender

```{r Exclusion gender}
dim(dat)

nogender <- dat %>%
  drop_na(gender)

missing_gender <- abs(nrow(nogender)-nrow(dat))
missing_gender
```

## mhd


```{r Exclusion no disorder}
dim(nogender)

missing_disorder <- nogender %>%
  filter(
    #gender == "Trans woman",
    #if_all(all_of(psy_dx_factors), is.na) | 
    !(mhd.agoraphobia == "Agoraphobia" | mhd.social_anxiety == "Social anxiety" |
      mhd.specific_phobia == "Specific phobia" |
      mhd.panic_disorder == "Panic disorder" |
      mhd.bipolar_disorder == "Bipolar disorder"),
    !any_gad_diagnosis == "GAD",
    !any_mdd_diagnosis == "MDD",
  )

nogender.nodisorder <- anti_join(nogender, missing_disorder, by = "ID")
nrow(missing_disorder)
```
`r abs(missing_disorder)` participants excluded due to missing mhd, cidia and cidid.


## sexual orientation


```{r Exclusion sexual orientation}
dim(nogender.nodisorder)

nogender.nodisorder.nosexualorientation <- nogender.nodisorder %>%
  drop_na(sexual_orientation)

missing_sexualorientation <- 
  nrow(nogender.nodisorder) - 
  nrow(nogender.nodisorder.nosexualorientation)
missing_sexualorientation
```


## Final

Final *n* = `r abs(nrow(nogender.nodisorder))`

Copy tibble after exclusion

```{r Move data frame}
dat_after_exclusion_gender <- 
  nogender.nodisorder
nrow(dat_after_exclusion_gender)
```
```{r Move data frame}
dat_after_exclusion_sexual_orientation <- 
  nogender.nodisorder.nosexualorientation
nrow(dat_after_exclusion_sexual_orientation)
```

# Write rds file

```{r write rds file exclusion}
dat_after_exclusion_gender %>%
  write_rds(
  file =  paste0(filepath_cleaned_data,"dat_after_exclusion_gender", date, ".rds")
  )
```

```{r write rds file exclusion}
dat_after_exclusion_sexual_orientation %>%
  write_rds(
  file =  paste0(filepath_cleaned_data,"dat_after_exclusion_sexual_orientation", date, ".rds")
  )
```
